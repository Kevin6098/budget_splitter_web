/**
 * Budget Splitter landing page – translations
 * Languages: en, zh, ms, ja
 */
const translations = {
  en: {
    nav: {
      features: 'Features',
      howItWorks: 'How it works',
      getApp: 'Get the app',
    },
    hero: {
      title: 'Split expenses fairly.',
      titleLine2: 'No awkward conversations.',
      lead: 'Trips, roommates, or shared costs—track who paid what, see who owes whom, and settle up in one place.',
      ctaPrimary: 'Get Xsplitter',
      ctaSecondary: 'See how it works',
    },
    mock: {
      trip: 'Trip: Tokyo',
      youOwe: 'You owe Alex',
      settled: 'Settled',
    },
    features: {
      title: 'Everything you need to split fairly',
      groupsTitle: 'Groups & members',
      groupsDesc: 'Create a group for your trip or household, add members, and invite with a code. Everyone stays in sync.',
      trackTitle: 'Track expenses',
      trackDesc: 'Log meals, transport, tickets, shopping, and more. Record who paid and split amounts per person.',
      owesTitle: 'Who owes whom',
      owesDesc: "See a clear summary of who's paid and who still owes. Mark as paid when you settle up.",
      currencyTitle: 'Multi-currency',
      currencyDesc: 'Supports JPY, MYR, SGD, and USD so you can split in the currency that fits your trip.',
    },
    how: {
      title: 'How it works',
      step1Title: 'Create a group',
      step1Desc: 'Name your trip or household and add members. Share an invite code so others can join.',
      step2Title: 'Log expenses',
      step2Desc: "Whenever someone pays—dinner, train tickets, groceries—add the expense and who paid. Split per person or evenly.",
      step3Title: 'Settle up',
      step3Desc: "Check the summary to see who owes whom. Mark as paid when you've settled. No spreadsheets, no guesswork.",
    },
    cta: {
      title: 'Ready to split fairly?',
      lead: 'Get Xsplitter and keep shared expenses simple.',
      button: 'Download on the App Store',
      note: 'iOS app — more platforms coming soon.',
    },
    footer: {
      copy: 'Split trip and household expenses fairly. No awkward conversations.',
      legal: 'All rights reserved.',
    },
  },
  zh: {
    nav: {
      features: '功能',
      howItWorks: '使用方式',
      getApp: '下载应用',
    },
    hero: {
      title: '公平分摊开销。',
      titleLine2: '不再尴尬开口。',
      lead: '旅行、合租或共同消费——记录谁付了啥、谁欠谁多少，一处结清。',
      ctaPrimary: '获取 Xsplitter',
      ctaSecondary: '查看使用方式',
    },
    mock: {
      trip: '行程：东京',
      youOwe: '你欠 Alex',
      settled: '已结清',
    },
    features: {
      title: '公平分摊所需的一切',
      groupsTitle: '群组与成员',
      groupsDesc: '为旅行或家庭创建群组，添加成员，用邀请码邀请。大家保持同步。',
      trackTitle: '记录开支',
      trackDesc: '记录餐饮、交通、门票、购物等。标明谁付款，按人分摊金额。',
      owesTitle: '谁欠谁',
      owesDesc: '一目了然谁已付、谁未付。结清后标记为已付。',
      currencyTitle: '多币种',
      currencyDesc: '支持日元、马币、新元、美元，按旅行所需币种分摊。',
    },
    how: {
      title: '使用方式',
      step1Title: '创建群组',
      step1Desc: '为旅行或家庭起名并添加成员。分享邀请码让他人加入。',
      step2Title: '记录开支',
      step2Desc: '有人付款时——晚餐、车票、日用品——添加开支与付款人，按人或均摊。',
      step3Title: '结清',
      step3Desc: '查看汇总了解谁欠谁。结清后标记为已付。无需表格，无需猜测。',
    },
    cta: {
      title: '准备公平分摊？',
      lead: '使用 Xsplitter，让共同开销变简单。',
      button: '在 App Store 下载',
      note: 'iOS 应用 — 更多平台即将推出。',
    },
    footer: {
      copy: '公平分摊旅行与家庭开销。不再尴尬开口。',
      legal: '版权所有。',
    },
  },
  ms: {
    nav: {
      features: 'Ciri-ciri',
      howItWorks: 'Cara guna',
      getApp: 'Dapatkan aplikasi',
    },
    hero: {
      title: 'Bahagikan perbelanjaan dengan adil.',
      titleLine2: 'Tiada lagi perbualan janggal.',
      lead: 'Trip, serumah, atau kos berkongsi—jejaki siapa bayar apa, lihat siapa berhutang dengan siapa, dan selesaikan di satu tempat.',
      ctaPrimary: 'Dapatkan Xsplitter',
      ctaSecondary: 'Lihat cara guna',
    },
    mock: {
      trip: 'Trip: Tokyo',
      youOwe: 'Anda berhutang Alex',
      settled: 'Selesai',
    },
    features: {
      title: 'Semua yang anda perlukan untuk bahagi dengan adil',
      groupsTitle: 'Kumpulan & ahli',
      groupsDesc: 'Cipta kumpulan untuk trip atau rumah anda, tambah ahli, dan jemput dengan kod. Semua kekal segerak.',
      trackTitle: 'Jejak perbelanjaan',
      trackDesc: 'Catat makan, pengangkutan, tiket, beli-belah, dan lain-lain. Rekod siapa bayar dan bahagikan jumlah per orang.',
      owesTitle: 'Siapa berhutang dengan siapa',
      owesDesc: 'Lihat ringkasan jelas siapa yang sudah bayar dan siapa masih berhutang. Tandakan dibayar bila anda selesaikan.',
      currencyTitle: 'Pelbagai mata wang',
      currencyDesc: 'Sokong JPY, MYR, SGD, dan USD supaya anda boleh bahagi dalam mata wang yang sesuai dengan trip anda.',
    },
    how: {
      title: 'Cara guna',
      step1Title: 'Cipta kumpulan',
      step1Desc: 'Namakan trip atau rumah anda dan tambah ahli. Kongsi kod jemputan supaya orang lain boleh sertai.',
      step2Title: 'Catat perbelanjaan',
      step2Desc: 'Bila-bila seseorang bayar—makan malam, tiket kereta api, runcit—tambah perbelanjaan dan siapa bayar. Bahagi per orang atau sama rata.',
      step3Title: 'Selesaikan',
      step3Desc: 'Semak ringkasan untuk lihat siapa berhutang dengan siapa. Tandakan dibayar bila anda sudah selesaikan. Tiada spreadsheet, tiada tekaan.',
    },
    cta: {
      title: 'Sedia untuk bahagi dengan adil?',
      lead: 'Dapatkan Xsplitter dan kekalkan perbelanjaan berkongsi mudah.',
      button: 'Muat turun di App Store',
      note: 'Aplikasi iOS — lebih banyak platform tidak lama lagi.',
    },
    footer: {
      copy: 'Bahagikan perbelanjaan trip dan rumah dengan adil. Tiada lagi perbualan janggal.',
      legal: 'Hak cipta terpelihara.',
    },
  },
  ja: {
    nav: {
      features: '機能',
      howItWorks: '使い方',
      getApp: 'アプリを入手',
    },
    hero: {
      title: '支出を公平に割り勘。',
      titleLine2: '言いづらいお金の話もスムーズに。',
      lead: '旅行、ルームシェア、共同出費——誰が何を払ったか、誰が誰にいくら返すか、一箇所で管理して精算できます。',
      ctaPrimary: 'Xsplitter を入手',
      ctaSecondary: '使い方を見る',
    },
    mock: {
      trip: '旅行：東京',
      youOwe: 'Alex に ¥8,200',
      settled: '精算済',
    },
    features: {
      title: '公平に割り勘するために必要なすべて',
      groupsTitle: 'グループとメンバー',
      groupsDesc: '旅行や世帯用のグループを作成し、メンバーを追加。招待コードで仲間を招待。みんなで同期できます。',
      trackTitle: '支出を記録',
      trackDesc: '食事、交通、チケット、買い物などを記録。誰が払ったか、何人でどう割るかを記録。',
      owesTitle: '誰が誰にいくら',
      owesDesc: '誰が支払済みで誰が未払いか、一目でわかるサマリー。精算したら「支払済」にマーク。',
      currencyTitle: '複数通貨',
      currencyDesc: 'JPY、MYR、SGD、USD に対応。旅行に合った通貨で割り勘できます。',
    },
    how: {
      title: '使い方',
      step1Title: 'グループを作成',
      step1Desc: '旅行や世帯の名前をつけてメンバーを追加。招待コードを共有して仲間を招待。',
      step2Title: '支出を記録',
      step2Desc: '誰かが払ったとき——食事、電車代、日用品——支出と支払者を追加。人数で割るか均等に。',
      step3Title: '精算',
      step3Desc: 'サマリーで誰が誰にいくら返すか確認。精算したら「支払済」にマーク。表計算も推測も不要。',
    },
    cta: {
      title: '公平に割り勘しませんか？',
      lead: 'Xsplitter で共同支出をシンプルに。',
      button: 'App Store でダウンロード',
      note: 'iOS アプリ — 他のプラットフォームも近日公開。',
    },
    footer: {
      copy: '旅行や世帯の支出を公平に割り勘。言いづらいお金の話もスムーズに。',
      legal: 'All rights reserved.',
    },
  },
};

const LANG_KEY = 'budget-splitter-lang';
const DEFAULT_LANG = 'en';

function getStoredLang() {
  try {
    const stored = localStorage.getItem(LANG_KEY);
    if (stored && translations[stored]) return stored;
  } catch (e) {}
  const browser = (navigator.language || navigator.userLanguage || '').toLowerCase();
  if (browser.startsWith('zh')) return 'zh';
  if (browser.startsWith('ms')) return 'ms';
  if (browser.startsWith('ja')) return 'ja';
  return DEFAULT_LANG;
}

function setLang(lang) {
  if (!translations[lang]) return;
  try {
    localStorage.setItem(LANG_KEY, lang);
  } catch (e) {}
  document.documentElement.lang = lang === 'zh' ? 'zh-Hans' : lang === 'ja' ? 'ja' : lang === 'ms' ? 'ms' : 'en';
  applyTranslations(lang);
  updateLangSwitcher(lang);
  updateMeta(lang, translations[lang]);
}

function getNested(obj, path) {
  const keys = path.split('.');
  let v = obj;
  for (const k of keys) {
    v = v && v[k];
  }
  return v != null ? String(v) : '';
}

function applyTranslations(lang) {
  const t = translations[lang] || translations[DEFAULT_LANG];
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.getAttribute('data-i18n');
    const value = getNested(t, key);
    if (value) {
      if (el.getAttribute('data-i18n-html')) {
        el.innerHTML = value;
      } else {
        el.textContent = value;
      }
    }
  });
}

function updateLangSwitcher(currentLang) {
  const btn = document.getElementById('lang-current');
  const list = document.getElementById('lang-list');
  const textEl = btn?.querySelector('.lang-trigger-text');
  if (textEl) textEl.textContent = langLabel(currentLang);
  if (list) {
    list.querySelectorAll('[data-lang]').forEach((el) => {
      const l = el.getAttribute('data-lang');
      el.classList.toggle('active', l === currentLang);
      el.setAttribute('aria-current', l === currentLang ? 'true' : 'false');
    });
  }
}

function langLabel(code) {
  const labels = { en: 'EN', zh: '中文', ms: 'BM', ja: '日本語' };
  return labels[code] || code.toUpperCase();
}

function updateMeta(lang, t) {
  const title = document.querySelector('title');
  const desc = document.querySelector('meta[name="description"]');
  const titleText = t.hero ? `${t.hero.title} ${t.hero.titleLine2}` : 'Xsplitter';
  const descText = t.hero ? t.hero.lead : '';
  if (title) title.textContent = titleText;
  if (desc && descText) desc.setAttribute('content', descText);
}

function initI18n() {
  const lang = getStoredLang();
  setLang(lang);

  const langBtn = document.getElementById('lang-current');
  const langList = document.getElementById('lang-list');

  langBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const isOpen = langList?.classList.toggle('open');
    langBtn?.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
  });

  document.querySelectorAll('#lang-list [data-lang]').forEach((el) => {
    el.addEventListener('click', (e) => {
      e.preventDefault();
      const l = el.getAttribute('data-lang');
      setLang(l);
      langList?.classList.remove('open');
      langBtn?.setAttribute('aria-expanded', 'false');
    });
  });

  document.addEventListener('click', () => {
    langList?.classList.remove('open');
    langBtn?.setAttribute('aria-expanded', 'false');
  });
  document.getElementById('lang-dropdown')?.addEventListener('click', (e) => e.stopPropagation());
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initI18n);
} else {
  initI18n();
}
